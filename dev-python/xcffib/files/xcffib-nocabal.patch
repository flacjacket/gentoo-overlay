diff --git a/Makefile b/Makefile
index d1d62f6..7712b32 100644
--- a/Makefile
+++ b/Makefile
@@ -12,12 +12,16 @@ CABAL=cabal --config-file=./cabal.config
 GEN=$(CABAL) new-run -j$(NCPUS) exe:xcffibgen --
 
 # you should have xcb-proto installed to run this
-xcffib: module/*.py xcffib.cabal $(shell find . -path ./test -prune -false -o -name \*.hs)
-	$(GEN) --input $(XCBDIR) --output ./xcffib
+xcffib: module/*.py $(shell find . -path ./test -prune -false -o -name \*.hs)
+	LD_LIBRARY_PATH=dist/build dist/build/xcffibgen/xcffibgen --input $(XCBDIR) --output ./xcffib
 	cp ./module/*py ./xcffib/
 	touch ./xcffib/py.typed
 	sed -i "s/__xcb_proto_version__ = .*/__xcb_proto_version__ = \"${XCBVER}\"/" xcffib/__init__.py
 	@if [ "$(TRAVIS)" = true ]; then python xcffib/ffi_build.py; else python xcffib/ffi_build.py > /dev/null 2>&1 || python3 xcffib/ffi_build.py; fi
+	sed -i "s/version = .*/version = \"${ver}\"/" setup.py
+	sed -i "s/__version__ = .*/__version__ = \"${ver}\"/" xcffib/__init__.py
+	sed -r -i -e "s/(^version = \s*)[\"0-9\.]*/\1\"${ver}\"/" setup.py
+	sed -r -i -e "s/(^version:\s*)[0-9\.]*/\1${ver}/" xcffib.cabal
 
 .PHONY: xcffib-fmt
 xcffib-fmt: module/*.py
